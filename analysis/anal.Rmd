---
output: latex_fragment
---

Here you can write the introduction of your report and include some text that will be transferred to the word file every time you re-run this Markdown

```{r}
library(viridis)
library(ggplot2)

dd <- read.csv(gzfile("../listings.csv.gz"), na.strings = c("", "N/A"))

dataset <- "airbnb"
```

Check the type of the R object created for the dataset

```{r}
class(dd)
```

without including the R instruction in the final document

```{r, echo=FALSE}
class(dd)
```

Get dimensions of the dataset
```{r}
dim(dd)
n<-dim(dd)[1]
K<-dim(dd)[2]

n
K
```
Check the variables

```{r}
names(dd)
```
Decide if you need to declare some more factor or date

```{r}
actives<-c(12, 15, 16, 17, 18, 22, 25, 26, 29, 33, 34, 37, 38, 40, 47, 48, 51,
           52, 53, 54, 56, 57, 58, 61, 62, 63, 66, 67, 69, 74)

# Check variable names
names(dd[,actives])

# Parse dates
dd$host_since <- as.Date(dd$host_since, format="%Y-%m-%d")

# Remove dollar sign and comma from price
dd$price <- as.numeric(sub("\\,", "", sub("\\$", "", dd$price)))

# Remove percent sign from rates
dd$host_response_rate <- as.numeric(sub("%", "", dd$host_response_rate))
dd$host_acceptance_rate <- as.numeric(sub("%", "", dd$host_acceptance_rate))
#dd$host_response_time[dd$host_response_time %in% c("", "N/A")] <- NA 

# convert booleans from "t" / "f" to logical
booleans <- c("host_is_superhost", "host_has_profile_pic", "host_identity_verified", "instant_bookable")
dd[,booleans] <- dd[,booleans] == "t"

```

Make categories

```{r}

dd$host_since_year <- factor(sub("-[0-9-]+","", dd$host_since))
dd$host_since_mm_dd <- as.Date(sub("[0-9]+[-]","", dd$host_since), format="%m-%d")

breaks <- as.Date(c("01-01","03-21","06-21","09-21", "12-21", "12-31"), format="%m-%d")
dd$host_since_season <- cut(dd$host_since_mm_dd, labels=c("Winter", "Spring", "Summer", "Autumn", "Winter"), breaks=breaks)

# add new category to actives
index_new <- grep("host_since_season", colnames(dd))
actives <- c(actives, index_new)
index_new <- grep("host_since_year", colnames(dd))
actives <- c(actives, index_new)

categories <- c("host_response_rate", "host_acceptance_rate")

for (k in categories) {
  newfield <- paste(sep = "", k, "_cat")
  dd[,newfield] <- cut(dd[,k],
                       breaks=c(-1,20,40,60,80,100),
                       labels=c("very low", "low", "average", "high", "very high"))
  
  # remove old category from actives
  actives <- actives[names(dd)[actives]!=k]
  
  # add new category to actives
  index_new <- grep(newfield, colnames(dd))
  actives <- c(actives, index_new)
}
actives <- unique(actives)

factors <- c("neighbourhood_group_cleansed", "host_response_time", "room_type")
dd[,factors] <- lapply(dd[,factors], factor)

#for (k in actives) {
  print(paste("Variable: ", actives, ": ", names(dd)[actives], " --- ", lapply(dd[,actives], class)))
#}
  
summary(dd[,actives])

```

Basic descriptive analysis for numerical variables

(decide the maximum number of colors you can need in a graph based on your metadata file)
```{r, echo=FALSE}
# listOfColors<-rainbow(10)
# 
# #par(ask=TRUE)
# 
# for(k in actives){
#   var_name <- names(dd)[k]
#   var_s <- sym(var_name)
#   print(paste("variable ", k, ":", var_name ))
#   if (!(is.numeric(dd[,k]) || class(dd[,k])=="Date")){
#     frecs<-table(as.factor(dd[,k]), useNA="ifany")
#     proportions<-frecs/n
#     #ojo, decidir si calcular porcentages con o sin missing values
#     pie(frecs, cex=0.6, main=paste("Pie of", var_name), col = listOfColors)
#     barplot(frecs, las=3, cex.names=0.7,
#             main=paste("Barplot of", var_name), col=listOfColors)
#     print(paste("Number of modalities: ", length(frecs)))
#     print("Frequency table")
#     print(frecs)
#     print("Relative frequency table (proportions)")
#     print(proportions)
#     print("Frequency table sorted")
#     print(sort(frecs, decreasing=TRUE))
#     print("Relative frequency table (proportions) sorted")
#     print(sort(proportions, decreasing=TRUE))
#    }else{
#      if(class(dd[,k])=="Date"){
#        print(summary(dd[,k]))
#        print(sd(dd[,k]))
#        #decide breaks: weeks, months, quarters...
#        hist(dd[,k],breaks="quarters", main=paste("Histogram of", var_name), xlab = var_name)
#      }else{
#        hist(dd[,k], main=paste("Histogram of", names(dd)[k]), xlab=var_name, col = listOfColors)
#        #boxplot(dd[,k], horizontal=TRUE, main=paste("Boxplot of", var_name), col = listOfColors)
#        print(ggplot(dd, aes(x="", y=!!var_s)) + geom_boxplot() + coord_flip())
#        print("Extended Summary Statistics")
#        print(summary(dd[,k]))
#        print(paste("sd: ", sd(dd[,k], na.rm=TRUE)))
#        print(paste("vc: ", sd(dd[,k], na.rm=TRUE)/mean(dd[,k], na.rm=TRUE)))
#       }
#    }
#}
#par(ask=FALSE)

#per exportar figures d'R per programa
#dev.off()
#png(file=mypath,width = 950, height = 800, units = "px")
#dev.off()
```

ggplot

```{r, echo=FALSE}
listOfColors<-rainbow(10)

#par(ask=TRUE)

for(k in actives){
  var_name <- names(dd)[k]
  var_s <- sym(var_name)
  print(paste("variable ", k, ":", var_name ))
  if (!(is.numeric(dd[,k]) || class(dd[,k])=="Date")){
    frecs<-table(as.factor(dd[,k]), useNA="ifany")
    proportions<-frecs/n
    #ojo, decidir si calcular porcentages con o sin missing values

    p <- ggplot(dd, aes(x="", fill=!!var_s)) + geom_bar(width = 1) + coord_polar("y", start=0)
    print(p)
    #pie(frecs, cex=0.6, main=paste("Pie of", var_name), col = listOfColors)

    p <- ggplot(dd, aes(x=!!var_s, fill=!!var_s)) + geom_bar(width = 0.7) + theme(legend.position = "none")
    print(p)
    #barplot(frecs, las=3, cex.names=0.7,
     #       main=paste("Barplot of", var_name), col=listOfColors)

    print(paste("Number of modalities: ", length(frecs)))
    print("Frequency table")
    print(frecs)
    print("Relative frequency table (proportions)")
    print(proportions)
    print("Frequency table sorted")
    print(sort(frecs, decreasing=TRUE))
    print("Relative frequency table (proportions) sorted")
    print(sort(proportions, decreasing=TRUE))
   }else{
     if(class(dd[,k])=="Date"){
       print(summary(dd[,k]))
       print(sd(dd[,k]))
       #decide breaks: weeks, months, quarters...

       #hist(dd[,k],breaks="quarters", main=paste("Histogram of", var_name), xlab = var_name)
       p <- ggplot(dd, aes(x=!!var_s)) + geom_histogram()
       print(p)
       
     }else{
       #hist(dd[,k], main=paste("Histogram of", names(dd)[k]), xlab=var_name, col = listOfColors)
       p <- ggplot(dd, aes(x=!!var_s)) + geom_histogram()
       print(p)

       #boxplot(dd[,k], horizontal=TRUE, main=paste("Boxplot of", var_name), col = listOfColors)
       print(ggplot(dd, aes(x="", y=!!var_s)) + geom_boxplot() + coord_flip())

       print("Extended Summary Statistics")
       print(summary(dd[,k]))
       print(paste("sd: ", sd(dd[,k], na.rm=TRUE)))
       print(paste("vc: ", sd(dd[,k], na.rm=TRUE)/mean(dd[,k], na.rm=TRUE)))
      }
   }
}
par(ask=FALSE)

#per exportar figures d'R per programa
#dev.off()
#png(file=mypath,width = 950, height = 800, units = "px")
#dev.off()
```
