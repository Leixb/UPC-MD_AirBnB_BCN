---
output: latex_fragment
---

```{r, echo=FALSE, message=FALSE}
library(viridis)
library(ggplot2)
library(kableExtra)
library(grid)
library(extrafont)
library(showtext)
font_add("LM Roman", regular = "latinmodern-math.otf")
```
```{r}
dd <- read.csv(gzfile("../listings.csv.gz"), na.strings = c("", "N/A"))

dataset <- "airbnb"
```

```{r}
class(dd)
```

Dimensions del the dataset:
```{r}
dim(dd)
n<-dim(dd)[1]
K<-dim(dd)[2]

n
K
```
Dataset variables:

```{r}
names(dd)
```

From these we variables we selected the following:

```{r, echo=FALSE}
actives<-c(12, 15, 16, 17, 18, 22, 25, 26, 29, 33, 34, 37, 38, 40, 47, 48, 51,
           52, 53, 54, 56, 57, 58, 61, 62, 63, 66, 67, 69, 74)

names(dd[,actives])
```

Parsing of dates, prices and percentages

```{r}
# Parse dates
dd$host_since <- as.Date(dd$host_since, format="%Y-%m-%d")

# Remove dollar sign and comma from price
dd$price <- as.numeric(sub("\\,", "", sub("\\$", "", dd$price)))

# Remove percent sign from rates
dd$host_response_rate <- as.numeric(sub("%", "", dd$host_response_rate))
dd$host_acceptance_rate <- as.numeric(sub("%", "", dd$host_acceptance_rate))

# convert booleans from "t" / "f" to logical
booleans <- c("host_is_superhost", "host_has_profile_pic",
              "host_identity_verified", "instant_bookable")
dd[,booleans] <- dd[,booleans] == "t"

```

Make categories

```{r}

dd$host_since_year <- factor(sub("-[0-9-]+","", dd$host_since))
dd$host_since_mm_dd <- as.Date(sub("[0-9]+[-]","", dd$host_since),
                               format="%m-%d")

breaks <- as.Date(c("01-01","03-21","06-21","09-21", "12-21", "12-31"), 
                  format="%m-%d")
dd$host_since_season <- cut(dd$host_since_mm_dd,
                            labels=c("Winter", "Spring",
                                     "Summer", "Autumn", "Winter"),
                            breaks=breaks)

# add new category to actives
index_new <- grep("host_since_season", colnames(dd))
actives <- c(actives, index_new)
index_new <- grep("host_since_year", colnames(dd))
actives <- c(actives, index_new)

categories <- c("host_response_rate", "host_acceptance_rate")

for (k in categories) {
  newfield <- paste(sep = "", k, "_cat")
  dd[,newfield] <- cut(dd[,k],
                       breaks=c(-1,20,40,60,80,100),
                       labels=c("very low", "low", "average",
                                "high", "very high"))

  # remove old category from actives
  actives <- actives[names(dd)[actives]!=k]

  # add new category to actives
  index_new <- grep(newfield, colnames(dd))
  actives <- c(actives, index_new)
}
actives <- unique(actives)

factors <- c("neighbourhood_group_cleansed", "host_response_time", "room_type")
dd[,factors] <- lapply(dd[,factors], factor)

```



## Summary of numerical variables

```{r, echo=FALSE, warning=FALSE, message=FALSE}


library("dplyr")
numerics <- dplyr::select_if(dd[,actives], is.numeric)
tab <- t(summary(numerics))
tab <- apply(tab, 2, function(x) sub(".*:","", x))
colnames(tab) <- c("Min", "1st Q.", "Median", "Mean", "3rd Q.", "Max", "NA's")
kbl(tab, booktabs = T) %>% #landscape()
  kable_styling(latex_options =c("scale_down"))
```


\pagebreak

# Basic descriptive analysis for numerical variables


```{r, echo=FALSE, out.width="80%", fig.align = 'center',  warning=FALSE, message=FALSE, results='asis', dev='tikz', fig.showtext=TRUE}

#par(ask=TRUE)

theme_font <- theme(text = element_text(family="LM Roman"))

for(k in actives){
  var_name <- names(dd)[k]
  var_s <- sym(var_name)
  #cat('\n\\begin{center}')
  cat('\n## ', var_name)
  #cat('\n\\end{center}')
  #print(paste("variable ", k, ":", var_name ))
  if (!(is.numeric(dd[,k]) || class(dd[,k])=="Date")){
    # factors
    # frecs<-table(as.factor(dd[,k]), useNA="ifany")
    # proportions<-frecs/n
    # #ojo, decidir si calcular porcentages con o sin missing values
    # 
    # p <- ggplot(dd, aes(x="", fill=!!var_s)) + geom_bar(width = 1) + coord_polar("y", start=0)
    # p <- p + labs(x=NULL) + theme_classic() + theme(axis.line = element_blank(),
    #       axis.text = element_blank(),
    #       axis.ticks = element_blank())
    # print(p)
    #pie(frecs, cex=0.6, main=paste("Pie of", var_name), col = listOfColors)
    
    frecs<-table(as.factor(dd[,k]), useNA="ifany")
    proportions<-frecs/n
    
    dfc <- as.data.frame(proportions)
    colnames(dfc)[1] <- var_name
    
    p <- ggplot(dfc, aes("", Freq, fill =!!var_s)) +
      geom_bar(width = 1, size = 1, color = "white", stat = "identity") +
      coord_polar("y") +
      geom_text(aes(label = paste0(round(Freq*100), "%")),   
                position = position_stack(vjust = 0.5),
                family="LM Roman") +
      labs(x = NULL, y = NULL, fill = NULL) +
      guides(fill = guide_legend(reverse = TRUE)) +
      #scale_fill_manual(values = c("#ffd700", "#bcbcbc", "#ffa500", "#254290")) +
      theme_classic() + theme_font + 
      theme(axis.line = element_blank(),
            axis.text = element_blank(),
            axis.ticks = element_blank())
    print(p)

    p <- ggplot(dd, aes(x=!!var_s, fill=!!var_s)) + geom_bar(width = 0.7) + theme(legend.position = "none", axis.text.x=element_text(angle = -90, hjust = 0))  + theme_font
    print(p)
    #barplot(frecs, las=3, cex.names=0.7,
     #       main=paste("Barplot of", var_name), col=listOfColors)
    
    #out[k,"Modalities"] <- length(frecs) 
    #print(paste("Number of modalities: ", length(frecs)))
    
    #print("Frequency table")
    #print(frecs)
    #print("Relative frequency table (proportions)")
    #print(proportions)
    
    #print("Frequency table sorted")
    #print(sort(frecs, decreasing=TRUE))
    table <- kbl(sort(frecs, decreasing=TRUE), booktabs = TRUE) %>% kable_styling(position = "center")
    cat(table)
    #cat("no cat")
    #kbl(sort(frecs, decreasing=TRUE))
    
    #print("Relative frequency table (proportions) sorted")
    #print(sort(proportions, decreasing=TRUE))
   }else{
     if(class(dd[,k])=="Date"){
       cat('\n\\begin{verbatim}')
       print(summary(dd[,k]))
       print(sd(dd[,k]))
       cat('\n\\end{verbatim}')
       #decide breaks: weeks, months, quarters...

       #hist(dd[,k],breaks="quarters", main=paste("Histogram of", var_name), xlab = var_name)
       p <- ggplot(dd, aes(x=!!var_s)) + geom_histogram()  + theme_font
       print(p)

     }else{
       #hist(dd[,k], main=paste("Histogram of", names(dd)[k]), xlab=var_name, col = listOfColors)
       hi <- ggplot(dd, aes(x=!!var_s)) + geom_histogram()  + theme_font
       

       #boxplot(dd[,k], horizontal=TRUE, main=paste("Boxplot of", var_name), col = listOfColors)
       bp <- ggplot(dd, aes(x="", y=!!var_s)) + geom_boxplot() + coord_flip()  + theme_font +
         labs(x = NULL, y = NULL, fill = NULL) 

       grid.newpage()
       grid.draw(rbind(ggplotGrob(bp), ggplotGrob(hi), size="last"))

       # cat('\n')
       cat("\n### Extended Summary Statistics")
       #cat('\n```')
       cat('\n\\begin{verbatim}')
       print(summary(dd[,k]))
       print(paste("sd: ", sd(dd[,k], na.rm=TRUE)))
       # 
       print(paste("vc: ", sd(dd[,k], na.rm=TRUE)/mean(dd[,k], na.rm=TRUE)))
       cat('\\end{verbatim}\n')
       #cat('\n```')
      }
   }
   cat('\n')
    cat('\\pagebreak')
    cat('\n')
     cat('\n')
}
par(ask=FALSE)
```
